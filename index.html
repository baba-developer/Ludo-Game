<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Racing - Controls Fixed</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #222; }
        canvas { width: 100%; height: 100%; display: block; }
        
        #top-ui { position: absolute; top: 0; width: 100%; padding: 10px; display: flex; justify-content: space-between; background: rgba(0,0,0,0.6); color: white; z-index: 20; box-sizing: border-box; }
        
        /* Buttons Design */
        #mobile-controls { 
            position: absolute; 
            bottom: 40px; 
            width: 100%; 
            display: flex; 
            justify-content: space-around; 
            z-index: 30;
            pointer-events: none;
        }
        
        .ctrl-btn { 
            width: 90px; 
            height: 90px; 
            background: rgba(255, 255, 255, 0.2); 
            border: 3px solid white; 
            border-radius: 50%; 
            color: white; 
            font-size: 40px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            pointer-events: auto; 
            user-select: none;
            -webkit-user-select: none;
        }
        
        .ctrl-btn:active { background: rgba(0, 210, 255, 0.6); transform: scale(0.9); }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="top-ui">
            <div>Score: <span id="scoreVal">0</span></div>
            <button onclick="location.reload()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px;">Restart</button>
        </div>
        
        <canvas id="gameCanvas"></canvas>

        <div id="mobile-controls">
            <div class="ctrl-btn" id="lBtn">◀</div>
            <div class="ctrl-btn" id="rBtn">▶</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('scoreVal');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        let score = 0;
        let gameActive = true;
        let car = { x: canvas.width/2 - 25, y: canvas.height - 150, w: 50, h: 90, speed: 8 };
        let enemies = [];
        
        // Movement state
        let moveLeft = false;
        let moveRight = false;

        // --- FIXED CONTROLS LOGIC ---
        const leftBtn = document.getElementById('lBtn');
        const rightBtn = document.getElementById('rBtn');

        // Left Button Events
        leftBtn.onpointerdown = (e) => { moveLeft = true; };
        leftBtn.onpointerup = (e) => { moveLeft = false; };
        leftBtn.onpointerleave = (e) => { moveLeft = false; };

        // Right Button Events
        rightBtn.onpointerdown = (e) => { moveRight = true; };
        rightBtn.onpointerup = (e) => { moveRight = false; };
        rightBtn.onpointerleave = (e) => { moveRight = false; };

        // Keyboard Support
        window.onkeydown = (e) => {
            if(e.key === "ArrowLeft") moveLeft = true;
            if(e.key === "ArrowRight") moveRight = true;
        };
        window.onkeyup = (e) => {
            if(e.key === "ArrowLeft") moveLeft = false;
            if(e.key === "ArrowRight") moveRight = false;
        };

        function draw3DCar(x, y, w, h, color) {
            // Shadow
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.fillRect(x + 5, y + 5, w, h);
            // Depth Layer
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            ctx.beginPath(); ctx.roundRect(x+2, y+2, w, h, 10); ctx.fill();
            // Main Body
            ctx.fillStyle = color;
            ctx.beginPath(); ctx.roundRect(x, y, w, h, 10); ctx.fill();
            // Window
            ctx.fillStyle = "rgba(255,255,255,0.3)";
            ctx.fillRect(x+10, y+15, w-20, 20);
        }

        function update() {
            if (!gameActive) return;

            // Car movement based on button state
            if (moveLeft && car.x > 0) car.x -= car.speed;
            if (moveRight && car.x < canvas.width - car.w) car.x += car.speed;

            if (Math.random() < 0.02 && enemies.length < 4) {
                let lane = Math.floor(Math.random() * 4);
                enemies.push({ x: lane * (canvas.width/4) + 10, y: -100, speed: 5 + (score/10) });
            }

            enemies.forEach((enemy, i) => {
                enemy.y += enemy.speed;
                // Collision
                if (car.x < enemy.x + 50 && car.x + 50 > enemy.x && car.y < enemy.y + 90 && car.y + 90 > enemy.y) {
                    gameActive = false;
                    alert("Game Over! Score: " + score);
                    location.reload();
                }
                if (enemy.y > canvas.height) {
                    enemies.splice(i, 1);
                    score++;
                    scoreElement.innerText = score;
                }
            });
        }

        function draw() {
            ctx.fillStyle = "#2c3e50";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Road Lines
            ctx.strokeStyle = "white"; ctx.setLineDash([20, 20]);
            for(let i=1; i<4; i++) {
                ctx.beginPath(); ctx.moveTo(i * (canvas.width/4), 0); ctx.lineTo(i * (canvas.width/4), canvas.height); ctx.stroke();
            }

            draw3DCar(car.x, car.y, car.w, car.h, "#00d2ff");
            enemies.forEach(e => draw3DCar(e.x, e.y, 50, 90, "#ff4757"));

            if(gameActive) {
                update();
                requestAnimationFrame(draw);
            }
        }

        draw();
    </script>
</body>
</html>
